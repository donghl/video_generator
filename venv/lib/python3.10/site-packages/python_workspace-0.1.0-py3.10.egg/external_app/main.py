import json
from datetime import datetime
from typing import Dict, Any
import os
import sys

# 添加项目根目录到Python路径
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

from projects.common.config import ConfigManager
from projects.project_a.main import process_data
from projects.project_b.main import analyze_json_data
from projects.common.utils import format_datetime, calculate_statistics

def generate_report(data: Dict[str, Any]) -> Dict[str, Any]:
    """生成综合报告，结合项目A和B的功能"""
    config = ConfigManager()
    current_time = datetime.now()
    
    report = {
        "timestamp": format_datetime(current_time),
        "raw_data": data,
        "analysis": {}
    }
    
    # 使用配置
    report_format = config.get("external_app", "report_format", "basic")
    save_history = config.get("external_app", "save_history", False)
    
    # 使用项目A的功能
    process_data()
    
    # 使用项目B的功能
    temp_dir = config.get("common", "temp_dir", "temp")
    os.makedirs(temp_dir, exist_ok=True)
    temp_file = os.path.join(temp_dir, "temp_data.json")
    
    with open(temp_file, "w") as f:
        json.dump(data, f)
    
    analyze_json_data(temp_file)
    
    # 添加额外的分析
    if "values" in data:
        extended_stats = calculate_statistics(data["values"])
        report["analysis"].update({
            "extended_statistics": extended_stats,
            "data_points": len(data["values"]),
            "has_negative": any(v < 0 for v in data["values"]),
            "has_zero": any(v == 0 for v in data["values"])
        })
    
    # 如果需要保存历史
    if save_history:
        history_file = config.get("external_app", "history_file", "reports.json")
        _save_to_history(report, history_file)
    
    return report

def _save_to_history(report: Dict[str, Any], history_file: str):
    """保存报告到历史文件"""
    history = []
    if os.path.exists(history_file):
        with open(history_file, 'r') as f:
            try:
                history = json.load(f)
            except json.JSONDecodeError:
                history = []
    
    history.append(report)
    
    with open(history_file, 'w') as f:
        json.dump(history, f, indent=2)

def main():
    """主函数"""
    # 示例数据
    test_data = {
        "values": [15.5, -2.3, 0.0, 42.1, 23.8, 17.9],
        "metadata": {
            "source": "external_app",
            "type": "test_data"
        }
    }
    
    print("开始生成综合报告...")
    print("-" * 50)
    
    report = generate_report(test_data)
    
    print("\n最终报告:")
    print("-" * 50)
    print(f"生成时间: {report['timestamp']}")
    print("\n分析结果:")
    for key, value in report["analysis"].items():
        if isinstance(value, dict):
            print(f"\n{key}:")
            for k, v in value.items():
                print(f"  {k}: {v}")
        else:
            print(f"{key}: {value}")

if __name__ == "__main__":
    main() 